<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Tag Music > 이메일/비밀번호 찾기</title>
<style>
	* {
		margin : 0;
		padding: 0;
	}
	.blind {
		display: none;
	}
	body {
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		overflow: hidden;
		background-color: black;
		color: whitesmoke;
	}
	.background_image {
		position: fixed;
		z-index: -100;
		top: 90;
		left: 0;
		width: 100%;
		height: 80%;
		margin : auto;
	}
	.contain {
		position: relative;
		width: 420px;
		height: 500px;
		margin: auto;
		text-align: center;
		padding-top: 40px;
		background-color: rgba(0,0,0,0.5);
		border-radius: 4px;
	}
	.find_box {
		position: relative;
		width: 410px;
		margin: 30px auto 0;
	}
	.btn_find {
		position: relative;
		width: 100%;
	}
	/* 선택영역 */
	.choose_find {
		padding: 10px;
		width: 160px;
		background-color: green;
		border: 1px solid floralwhite;
	}
	.btn_email {
		display: inline-block;
	}
	.btn_pw {
		display: inline-block;
	}
	/* 공통 */
	.input_area {
		position: relative;
		width: 90%;
		margin: 0 auto;
		text-align: left;
	}
	.input_box_area {
		position: relative;
		text-align: center;
		width: 100%;
	}
	.input_box {
		position: relative;
		width: 365px;
		height: 40px;
		line-height: 40px;
	}
	.btn {
		margin-top: 20px;
		width: 180px;
		height: 40px;
		background-color: #9aeced;
	}
	#btn_find:hover {
		background-color: #141D48;
		color: white;
		outline: 1px solid gray;
	}
	/* 이메일 찾기 */
	.find_id_box {
		position: relative;
		width: 100%;
		padding: 30px 0;
		border: none;
	}
	
	/* 비밀번호 찾기 */
	.find_pw_box {
		position: relative;
		width: 100%;
		padding: 30px 0;
		border: none;
	}
	/* 결과창 (모달창) */
	.backlayer {
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background-color: rgba(0,0,0,0.8);
	}
	.result_wrap {
		position: fixed;
		top: 260px;
		left: 0;
		width: 100%;
		height: 100px;
	}
	.result_box {
		position: relative;
		margin: auto;
		width: 460px;
		height: 160px;
		background-color: rgb(33,33,33);
		border-radius: 8px;
		padding-top: 26px;
		line-height: 43px;
	}
	
</style>
<script th:src="@{/js/jquery-3.6.1.min.js}"></script>
<script th:src="@{/js/moment-with-locales.js}"></script>
<script>
	$(document).ready(function(){
		fn_findEmail();
		fn_findPw();
		fn_chooseFind();
		fn_close_popup_msg();
	});
	
	function fn_findEmail(){
		$('#btn_findEmail').click(function(){
			
			$.ajax({
				url: '/user/findEmail',
				type: 'POST',
				contentType: 'application/json',
				data: JSON.stringify({
					name: $('#name').val(),
					mobile: $('#mobile').val()
				}),
				dataType: 'json',
				success: function(resData) {
					$('.backlayer').removeClass('blind');
					$('.result_wrap').removeClass('blind');
					if (resData.findUser != null) {
						let email = resData.findUser.email;
						email = email.substring(0, 100);
						moment.locale('ko-KR');
						$('#msg_result').html('회원님의 이메일 정보입니다.<br><span style="font-size:20px; font-weight: 700;">' + email + '</span><br>(가입일 : ' + moment(resData.findUser.joinDate).format("YYYY년 MM월 DD일 a h:mm:ss") + ')');
					} else {
						$('#msg_result').html('일치하는 회원이 없습니다. 입력 정보를 확인하세요.');
					}
				}
			});
		});
	}
	
	function fn_findPw(){
		$('#btn_findPw').click(function(){
			new Promise(function(resolve, reject){
				if($('#email').val() == ''){
					reject('이메일을 입력하세요.');
					return;
				}
				$.ajax({
					url: '/user/findPw',
					type: 'post',
					contentType: 'application/json',
					data: JSON.stringify({
						'email': $('#email').val()
					}),
					dataType: 'json',
					success: function(resData){
						if(resData.findUser != null){
							$('.backlayer').removeClass('blind');
							resolve(resData.findUser);
						} else {
							reject('일치하는 회원 정보가 없습니다.');
						}
					}
				});		
			}).then(function(findUser){
				$.ajax({
					url: '/user/sendTemporaryPassword',
					type: 'post',
					data: 'userNo=' + findUser.userNo + '&email=' + findUser.email,
					dataType: 'json',
					success: function(resData){
						console.log('resData: ' + resData.isSuccess);
						if(resData.isSuccess){
							alert('등록된 이메일로 임시 비밀번호가 발송되었습니다.');
							location.href = '/user/login/form';
						}
					},
					error: function(){
						alert('error');
					}
				});
			}).catch(function(msg){
				alert(msg);
			});
		});
	}
	
	function fn_chooseFind(){
		$('.btn_email').click(function(){
			$('.find_id_box').removeClass('blind');
			$('.find_pw_box').addClass('blind');
		});
		
		$('.btn_pw').click(function(){
			$('.find_id_box').addClass('blind');
			$('.find_pw_box').removeClass('blind');
		});
	}
	
	function fn_close_popup_msg(){
		$('.backlayer').click(function(){
			$('.backlayer').addClass('blind');
			$('.result_wrap').addClass('blind');
		});
	}
</script>
</head>

<body>
	<div th:replace="~{layout/loginHeader.html::loginFragment}"></div>
	<img class="background_image" th:src="@{/images/login_help.jpeg}">
	<div class="contain">
		<div>
			이메일/비밀번호를 잊으셨나요?		
		</div>
		<div>
			비밀번호 재설정 안내를 받을 방법을 선택하세요.
		</div>
		
		<!--아이디 / 비밀번호 찾기 박스-->
		<div class="find_box">
			<div class="btn_find">
				<div class="choose_find btn_email">
					<span class="find_email">이메일 찾기</span>
				</div>
				<div class="choose_find btn_pw">
					<span class="find_pw">비밀번호 찾기</span>
				</div>
			</div>
			<div class="find_id_box">
				<form id="frm_findId">
					<div class="input_area input_name">
						<div class="input_msg">
							이름
						</div>
						<div class="input_box_area">
							<input type="text" name="name" id="name" class="input_box">
						</div>
					</div>	
					<div class="input_area input_mobile">
						<div class="input_msg">
							휴대폰 번호
						</div>
						<div class="input_box_area">
							<input type="text" name="mobile" id="mobile" class="input_box"> * 하이푼(-) 없이 입력해주세요.
						</div>
					</div>
					<div>
						<input type="button" value="이메일찾기" id="btn_findEmail" class="btn btn_findEmail">
					</div>
				</form>
			</div>
			<div class="find_pw_box blind">
				<form id="frm-findPw">
					<div class="input_area input_email">
						<div class="input_msg">
							이메일
						</div>
						<div class="input_box_area">
							<input type="text" name="email" id="email" class="input_box">
						</div>
						<div class="input_box_area">
							<input type="button" value="비밀번호찾기" id="btn_findPw" class="btn btn_findPw">
						</div>
					</div>
				</form>
			</div>
		</div>
		
		--------------
		
		<div>
			<a th:href="@{/user/join/agree}">회원가입</a>
		</div>
		<div class="backlayer blind"></div>
		<div class="result_wrap blind">
			<div class="result_box">
				<div id="msg_result"></div>
			</div>
		</div>
		
	</div>
</body>
</html>