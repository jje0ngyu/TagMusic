<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout/header::head('Tag Music')}"></head>
<meta charset="UTF-8">
<title>Tag Music > 상세보기</title>
<link rel="stylesheet" th:href="@{/css/tuneDetail.css}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
<style>
	.loading_bar {
		width: 200px;
		height: 200px;
		background-image: url('../../../resources/images/loading.gif');
		background-size: 200px 200px;
	}
</style>
<script th:src="@{/js/jquery-3.6.1.min.js}"></script>
<script>
	$(function(){
		fn_tabContent();
		fn_next_track_box();
		fn_lyrics_box();
		fn_comment_box();
		fn_icon();
	});

	function fn_tabContent(){
		$('.tune_tab_content').click(function(){
			$('.tune_tab_content').removeClass('border_bottom_solid_white');
			$('.tune_next_track_box').addClass('blind');
			$('.tune_lyrics_box').addClass('blind');
			$('.tune_comment_box').addClass('blind');
			$(this).addClass('border_bottom_solid_white');
		});
	}
	
	function fn_next_track_box(){
		$('.tab_next_track').click(function(){
			$('.tune_next_track_box').removeClass('blind');
		});
	}
	
	function fn_lyrics_box(){
		$('.tab_lyrics').click(function(){
			$('.tune_lyrics_box').removeClass('blind');
		});
	}
	function fn_comment_box(){
		$('.tab_comment').click(function(){
			$('.tune_comment_box').removeClass('blind');
		});
	}
	
	function fn_click_album_image(){
		$('#albumImg').click(function(){
			var imgSrc =  $(this).attr('src').val();
			$('#music_iframe').attr('src', imgSrc);
		});
	}
	
	var i = 0;	// 플레이 중인지 아닌지 확인하는 변슈
	function fn_icon() {
		$('.tune_main_panel').on('click', function(){
			if(i==0) {
				$('i').attr('class', 'bi bi-pause-circle-fill');
				$('i').css('animation-play-state','running');
				i++;
				location.href='/tune/iframe?musicNo=26';
			} else {
				$('i').attr('class', 'bi bi-play-circle-fill');
				$('i').css('animation-play-state','running');
				i--;
			}
		});
	}

</script>
<style>

</style>
</head>
<body>
	<div th:replace="~{layout/header.html::header_layout}"></div>
	<div th:replace="~{layout/side.html::side_layout}"></div>
	
	<div class="tune_container">
		<div class="tune_content">
			<div class="tune_main_panel">
				<div class="flex_center blind">
					<i class="bi bi-play-circle-fill"></i>
				</div>
				<div class="flex_center">
				</div>
				<img th:src="@{/tune/display/image(musicNo=${music.musicNo})}" name="image" class="tune_album_img">
			</div>
			<div class="tune_side_panel">
				<div class="tune_tab">
					<div class="tune_tab_content tab_next_track border_bottom_solid_white">
						다음 트랙
					</div>
					<div class="tune_tab_content tab_lyrics">
						가사
					</div>
					<div class="tune_tab_content tab_comment">
						댓글
					</div>
				</div>
				<div class="tune_next_track_box">
					다음 트랙
					1
					2
					3
					4
					...
				</div>
				<div class="tune_lyrics_box blind">
					<textarea class="tune_lyrics" th:text="${music.musicContent}"></textarea>
				</div>
				
				<!-- 댓글 -->
				<div class="tune_comment_box blind">
					<span id="btn_comment_list">
						댓글
						<span id="comment_count"></span>개
					</span>
					<div>
						<form id="frm_comment">
							<div>
								<input type="hidden" name="email" th:value="${session.loginUser.email}">
								<input type="hidden" name="musicNo" th:value="${music.musicNo}">	
								<input type="text" name="commentContent" id="commentContent" placeholder="댓글을 작성하려면 로그인 해 주세요.">
								<input type="button" value="작성완료" id="btn_add_comment">
							</div>
						</form>
					</div>
					<div id="comment_list"></div>
					<div id="paging"></div>
					<!--/* 현재 페이지 번호를 저장하고 있는 hidden */-->
					<input type="hidden" id="page" value="1">
				</div>
				
				
				<!-- 음원 다운로드 -->
				<div class="blind">
					<a th:href="@{/tune/download(musicNo=${music.musicNo})}">음원 다운로드 하기</a>
				</div>
			</div>
		</div>
		
		<script>
			$(function(){
				// 댓글
				fn_commentCount();
				fn_commentList();
				fn_addComment();
				fn_removeComment();

			});
			
			function fn_commentCount(){
			$.ajax({
				type: 'get',
				url: '/comment/getCount',
				data: 'musicNo=[[${music.musicNo}]]',
				dataType: 'json',
				success: function(resData){  // resData = {"commentCount": 개수}
					alert('resData.commentCount: ' + resData.commentCount);
					$('#comment_count').text(resData.commentCount);
				}
			});
		}
			
			function fn_commentList(){
				$.ajax({
					type: 'get',
					url: '/comment/list',
					data: 'musicNo=[[${music.musicNo}]]&page=' + $('#page').val(),
					dataType: 'json',
					success: function(resData){
						/*
							resData = {
								"commentList": [
									{댓글하나},
									{댓글하나},
									...
								],
								"pageUtil": {
									page: x,
									...
								}
							}
						*/
						// 화면에 댓글 목록 뿌리기
						$('#comment_list').empty();
						$.each(resData.commentList, function(i, comment){
							var div = '';
								div += '<div>';
								div += '<div style="margin-left: 40px;">';
							
								div += '<div>';
								div += comment.commentContent;
								// 작성자만 삭제할 수 있도록 if 처리
								if (comment.email == '${session.loginUser.email}' || '${session.loginUser.userNo}' == 1) {
									div += '<input type="button" value="삭제" class="btn_comment_remove" data-comment_no="' + comment.commentNo + '">';
								}
								div += '</div>';
							
							div += '<div>';
							moment.locale('ko-KR');
							div += '<span style="font-size: 12px; color: silver;">' + moment(comment.createDate).format('YYYY. MM. DD hh:mm') + '</span>';
							div += '</div>';
							div += '</div>';
							$('#comment_list').append(div);
							$('#comment_list').append('<div style="border-bottom: 1px dotted gray;"></div>');
						});
						// 페이징
						$('#paging').empty();
						var pageUtil = resData.pageUtil;
						var paging = '';
						// 이전 블록
						if(pageUtil.beginPage != 1) {
							paging += '<span class="enable_link" data-page="'+ (pageUtil.beginPage - 1) +'">◀</span>';
						}
						// 페이지번호
						for(let p = pageUtil.beginPage; p <= pageUtil.endPage; p++) {
							if(p == $('#page').val()){
								paging += '<strong>' + p + '</strong>';
							} else {
								paging += '<span class="enable_link" data-page="'+ p +'">' + p + '</span>';
							}
						}
						// 다음 블록
						if(pageUtil.endPage != pageUtil.totalPage){
							paging += '<span class="enable_link" data-page="'+ (pageUtil.endPage + 1) +'">▶</span>';
						}
						$('#paging').append(paging);
					}
				});
			}  // fn_commentList
			
			function fn_addComment(){
				$('#btn_add_comment').click(function(){
					if($('#commentContent').val() == ''){
						alert('댓글 내용을 입력하세요');
						return;
					}
					$.ajax({
						type: 'post',
						url: '/comment/add',
						data: $('#frm_comment').serialize(),
						dataType: 'json',
						success: function(resData){  // resData = {"isAdd", true}
							if(resData.isAdd){
								alert('댓글이 등록되었습니다.');
								$('#commentContent').val('');
								fn_commentList();   // 댓글 목록 가져와서 뿌리는 함수
								fn_commentCount();  // 댓글 목록 개수 갱신하는 함수
							}
						}
					});
				});
			}
			function fn_removeComment(){
				$(document).on('click', '.btn_comment_remove', function(){
					if(confirm('삭제된 댓글은 복구할 수 없습니다. 댓글을 삭제할까요?')){
						$.ajax({
							type: 'post',
							url: '/comment/remove',
							data: 'commentNo=' + $(this).data('comment_no'),
							dataType: 'json',
							success: function(resData){  // resData = {"isRemove": true}
								if(resData.isRemove){
									alert('댓글이 삭제되었습니다.');
									fn_commentList();
									fn_commentCount();
								}
							}
						});
					}
				});
			}
			
			
			var timer;
			// 스크롤 이벤트
			$(window).scroll(function(){
				// 동일한 setTimeout이 다시 요청되었다면 setTimeout 동작 취소
				if(timer) {
					clearTimeout(timer);
				}
				// 마지막 스크롤 후 0.2초 후에 동작하는 setTimeout
				timer = setTimeout(function(){
					var scrollTop = $(this).scrollTop();        // 스크롤 된 길이
					var windowHeight = $(this).height();        // 웹 브라우저(화면) 높이
					var documentHeight = $(document).height();  // 문서 전체 높이
					if((scrollTop + windowHeight) >= documentHeight){  // 스크롤이 화면 끝까지 내려갔음
						if(page > totalPage){  // 마지막 페이지를 넘어가면 동작 안함
							return;
						}
						fn_commentList();
					}
				}, 200);  // 200밀리초 = 0.2초(시간은 알아서 조절할 것)
			});
		</script>
			<!-- 로딩바 -->
		<div class="wrapper">	
			<div class="loading_bar"></div>
		</div>
	</div>
</body>
</html>