<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<script th:src="@{/js/jquery-3.6.1.min.js}"></script>
<script th:src="@{/js/moment-with-locales.js}"></script>
<script>
	$(document).ready(function(){
		fn_findEmail();
		fn_findPw();
	});
	
	function fn_findEmail(){
		$('#btn_findEmail').click(function(){
			
			$.ajax({
				url: '/user/findEmail',
				type: 'POST',
				contentType: 'application/json',
				data: JSON.stringify({
					name: $('#name').val(),
					mobile: $('#mobile').val()
				}),
				dataType: 'json',
				success: function(resData) {
					console.log('name' + name);
					console.log('mobile' + mobile);
					if (resData.findUser != null) {
						let email = resData.findUser.email;
						email = email.substring(0, 100) + '*****';
						moment.locale('ko-KR');
						$('#msg_result').html('회원님의 이메일은 ' + email + '입니다.<br>(가입일 : ' + moment(resData.findUser.joinDate).format("YYYY년 MM월 DD일 a h:mm:ss") + ')');
					} else {
						$('#msg_result').html('일치하는 회원이 없습니다. 입력 정보를 확인하세요.');
					}
				}
			});
		});
	}
	
	function fn_findPw(){
		$('#btn_findPw').click(function(){
			new Promise(function(resolve, reject){
				if($('#email').val() == ''){
					reject('이메일을 입력하세요.');
					return;
				}
				$.ajax({
					url: '/user/findPw',
					type: 'post',
					contentType: 'application/json',
					data: JSON.stringify({
						'email': $('#email').val()
					}),
					dataType: 'json',
					success: function(resData){
						if(resData.findUser != null){
							resolve(resData.findUser);
						} else {
							reject('일치하는 회원 정보가 없습니다.');
						}
					}
				});		
			}).then(function(findUser){
				$.ajax({
					url: '/user/sendTemporaryPassword',
					type: 'post',
					data: 'userNo=' + findUser.userNo + '&email=' + findUser.email,
					dataType: 'json',
					success: function(resData){
						console.log('resData: ' + resData.isSuccess);
						if(resData.isSuccess){
							alert('등록된 이메일로 임시 비밀번호가 발송되었습니다.');
							location.href = '/user/login/form';
						}
					},
					error: function(){
						alert('error');
					}
				});
			}).catch(function(msg){
				alert(msg);
			});
		});
	}
</script>
</head>

<body>
	<div th:replace="~{layout/loginHeader.html::loginFragment}"></div>
	<div>
		이메일/비밀번호를 잊으셨나요?		
	</div>
	<div>
		비밀번호 재설정 안내를 받을 방법을 선택하세요.
	</div>
	
	<!--아이디 / 비밀번호 찾기 박스-->
	<div>
		
		<div>
			<span class="find_email">이메일 찾기</span>
			<span class="find_pw">비밀번호 찾기</span>
		</div>
		<form id="frm_findId">
			<div>
				이름<input type="text" name="name" id="name">
			</div>	
			<div>
				휴대폰 번호<input type="text" name="mobile" id="mobile"> * 하이푼(-) 없이 입력해주세요.
			</div>
			<div>
				<input type="button" value="이메일찾기" id="btn_findEmail">
			</div>
		</form>
		
		<form id="frm-findPw">
			<div>
				이메일<input type="text" name="email" id="email">
			</div>
			<div>
				<input type="button" value="비밀번호찾기" id="btn_findPw">
			</div>
		</form>
		
	</div>
	
	--------------
	
	<div>
		<a href="${contextPath}/user/agree/form">회원가입</a>
	</div>
	
	<hr>
	
	<div id="msg_result"></div>
</body>
</html>