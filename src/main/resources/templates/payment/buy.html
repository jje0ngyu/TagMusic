<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout/header::head('Tag Music')}"></head>
<meta charset="UTF-8">

<title></title>
<style>
	ul,ol{list-style:none}
	a{text-decoration:none;color:#fff962;font-size:15px}
	nav{overflow:hidden;height:80px;background-color:#1b2035; margin-top:150px;}
	#nav3 {
	  width: 100%;
	  height: 10%;
	  position: relative;
	  text-align: center;
	}
	#nav3>a {
	  line-height: 80px;
	  display: block;
	  font-size: 30px;
	  font-weight: 900;
	  position: absolute;
	  left: 30px;
	}
	#nav3>select {
	  padding: 0 20px;
	  height: 30px;
	  background-color: #1b2035;
	  color: #fff;
	  position: absolute;
	  right: 30px;
	  top: 50%;
	  transform: translateY(-15px);
	  border: 2px solid #fff;
	  border-radius: 30px;
	}
	#nav3>ul {
	  display: inline-block;
	}
	#nav3>ul li {
	  float: left;
	  line-height: 80px;
	  padding: 0 30px;
	}
	
	.payContent {
 		margin: 50px auto 0;
 		position: relative;
 		width: 1200px;
	}
	#buyPageDiv{
		margin: 10px auto;
		padding: 50px;
		position: relative;
    	width: 100%;
    	background-color: #ECECEC;
    	
	}
	.pass_box {
		width: 420px;
		margin: auto;
	}
	.pass_name {
		position: relative;
		display: inline-block;
	}
	.pass_btn {
		position: relative;
		display: inline-block;
	}
	
	/* 선물 box */
	.blind {
		display: none;
	}
	.backlayer {
		position: absolute;
		top: 0;
		left: 0;
		background-color: rgba(0,0,0,0.7);
		z-index: 100;
		width: 100%;
		height:100%;
	}
	.gift_session {
		position: absolute;
		top: 0;
		left: 0;
		background-color: rgba(255,255,255,0);
		width: 100%;
		height:100%;
	}
	.container_gift {
		position: relative;
		z-index: 110;
		width: 420px;
		height: 300px;
		background-color: white;
		margin: 200px auto;
	}
	.gift_box {
		position: relative;
		margin: auto;
		width: 300px;
		background-color: green;
		text-align: center;
	}
	
	
</style>
<!-- static 폴더 이후의 위치를 적으면 된다. -->
<script th:src="@{/js/jquery-3.6.1.min.js}"></script>
<script type="text/javascript" src="https://service.iamport.kr/js/iamport.payment-1.1.5.js"></script>

<script th:inline="javascript">
$(document).ready(function(){
	var userName = $('#userName').data('name');
	if(userName != null){
		fn_passList();
	} else {
		fn_isNotUser();
	}
	
 });
function fn_isNotUser(){
	$.ajax({
		type: 'post',
		url: '/pass/list',
		dataType: 'json',
		success: function(resData){
			var txt = '';
			$.each(resData.passList, function(i, pass){
				txt += '<div class="pass_box">';
				txt += '<div class="pass_name">';
				txt += '<h2>'+pass.passName+'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'+pass.passPrice+' 원!</h2>';
				txt += '</div>';
				txt += '<div class="pass_btn">';
				txt += '<input type="button" value="결제하기" onclick="fn_login()">';
				if(pass.passName == "30일이용권"){
					txt += '<input type="button" value="선물하기" id="btn_gift" onclick="fn_login()">';
				}
				
				txt += '</div>';
				txt += '</div>';
			});
			$('#buyPageDiv').append(txt);
		}
	});
}
function fn_passList(){
	$.ajax({
		type: 'post',
		url: '/pass/list',
		dataType: 'json',
		success: function(resData){
			var txt = '';
			$.each(resData.passList, function(i, pass){
				txt += '<div class="pass_box">';
				txt += '<div class="pass_name">';
				txt += '<h2>'+pass.passName+'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'+pass.passPrice+' 원!</h2>';
				txt += '</div>';
				txt += '<div class="pass_btn">';
				txt += '<input type="button" value="결제하기" data-ticket="'+ pass.passName+'" data-passno="'+pass.passNo+'" data-pg="inicis통합결제" data-amount="'+pass.passPrice+'" onclick="fn_buyTicket(this)">';
				if(pass.passName == "30일이용권"){
					txt += '<input type="button" id="btn_gift" value="선물하기" data-ticket="'+ pass.passName + '" data-passno="'+pass.passNo+'" data-pg="inicis통합결제" data-amount="'+pass.passPrice+'" onclick="fn_presentTicket(this)">';
				}
				txt += '</div>';
				txt += '</div>';
			});
			
			$('#buyPageDiv').append(txt);
		}
	});
}
function fn_login(){
	alert('아직 로그인을 안하셨네요! 로그인 페이지로 이동합니다!');
	$('#frm_login').submit();
}

function fn_buyTicket(e){
	
		
	
	
	var musicAmount = $(e).data('amount');
	var paymentPg = $(e).data('pg');
	var ticketName = $(e).data('ticket');
	var passNo = $(e).data('passno');
	var userName = $('#userName').data('name');
	var userEmail = $('#userEmail').data('email');
	var userMobile = $('#userMobile').data('mobile');
	var userAddr = '';
	userAddr += $('#userAddr1').data('addr');
	userAddr += $('#userAddr2').data('addr');
	userAddr += $('#userAddr3').data('addr');
	userAddr += $('#userAddr4').data('addr');
	var userPostcode = $('#postcode').data('postcode');
		
	var IMP = window.IMP; 
		
	
	IMP.init('imp66111374');//imp72345478
	
	var merchant_uid = 'TagMusic_' + new Date().getTime();
	console.log(musicAmount + userEmail +userMobile );
	IMP.request_pay({ 
		pg: "html5_inicis",
		pay_method: 'card',
		merchant_uid: merchant_uid,
		name: ticketName, 
		//name: '노래제목:'+firstCartMusicName+' 외'+ (muprice-1) +'곡',
		amount: musicAmount,
		buyer_email: userEmail,
		buyer_name: userName,
		buyer_tel: userMobile,
		buyer_addr: '서울시',
		buyer_postcode: '123-111',
		m_redirect_url: 'https://www.yourdomain.com/payments/complete'
		}, function (rsp) {
			if (rsp.success) {
				 $.ajax({
					type: 'post',
					url: '/payment/thirtyDay',
					data: 'email=' + userEmail + '&price=' + musicAmount + '&passNo=' + passNo + '&payPg=' + paymentPg + '&ticketName=' + ticketName + '&merchantUid=' + merchant_uid,
					dataType: 'json',
					success: function(resData){
						var msg = '';
						console.log(resData);
						if(resData.result == 1){
							msg += '이용권 구매가 완료되었습니다.';
						} else {
							msg += '이용권 구매가 실패하였습니다..';
						}
						alert(msg);
						fn_remainingDay();
					}
					
				}); 
			} else {
			var msg = '';
			msg += rsp.error_msg;
			alert(msg)
		}
	});
	
}
function fn_presentTicket(e){
	$('.backlayer').removeClass('blind');
	$('.gift_session').removeClass('blind');
	var userNickName = prompt("어떤 유저에게 선물하시겠습니까? 유저의 이메일을 입력해주세요!", "이메일 입력");
	var ticketName = $(e).data('ticket');
	ticketName += '(TO.'+ userNickName +')';
	if(confirm('\'' + userNickName + '\' 에게 선물하시겠습니까??')){
		
		var musicAmount = $(e).data('amount');
		var paymentPg = $(e).data('pg');
		
		var passNo = $(e).data('passno');
		var userName = $('#userName').data('name');
		var userEmail = $('#userEmail').data('email');
		var userMobile = $('#userMobile').data('mobile');
		var userAddr = '';
		userAddr += $('#userAddr1').data('addr');
		userAddr += $('#userAddr2').data('addr');
		userAddr += $('#userAddr3').data('addr');
		userAddr += $('#userAddr4').data('addr');
		var userPostcode = $('#postcode').data('postcode');
			
		var IMP = window.IMP; 
			
		
		IMP.init('imp66111374');//imp72345478
		
		var merchant_uid = 'TagMusic_' + new Date().getTime();
		
		IMP.request_pay({ 
			pg: "html5_inicis",
			pay_method: 'card',
			merchant_uid: merchant_uid,
			name: ticketName, 
			//name: '노래제목:'+firstCartMusicName+' 외'+ (muprice-1) +'곡',
			amount: musicAmount,
			buyer_email: userEmail,
			buyer_name: userName,
			buyer_tel: userMobile,
			buyer_addr: '서울시',
			buyer_postcode: '123-111',
			m_redirect_url: 'https://www.yourdomain.com/payments/complete'
			}, function (rsp) {
				if (rsp.success) {
					 $.ajax({
						type: 'post',
						url: '/payment/thirtyDay',
						data: 'email=' + userEmail + '&price=' + musicAmount + '&passNo=' + passNo + '&payPg=' + paymentPg + '&ticketName=' + ticketName + '&merchantUid=' + merchant_uid,
						dataType: 'json',
						success: function(resData){
							var msg = '';
							console.log(resData);
							if(resData.result == 1){
								msg += '이용권 구매가 완료되었습니다.';
							} else {
								msg += '이용권 구매가 실패하였습니다..';
							}
							alert(msg);
							fn_remainingDay();
						}
						
					}); 
				} else {
				var msg = '';
				msg += rsp.error_msg;
				alert(msg)
			}
		});
	}
	console.log(ticketName);
}

</script>
</head>
<body>
	
	<div th:replace="~{layout/header.html::header_layout}"></div>

	<div class="session">
		<div th:replace="~{layout/side.html::side_layout}"></div>
		
		
		<!--  ** 모든 컨텐츠는 해당 content태그 아래에서 작성하시오  ** -->
		<div class="payContent">
			<nav id="nav3">
				<h1>이용권 구매</h1>
				<hr>
				<ul>
					<li>
						<a th:href="@{/payment/buy}">태그뮤직 BEST</a>
					</li>
				</ul>
			</nav>
			<input type="hidden" id="isUser" th:data-user="${session}">
			<div th:if="${session.loginUser != null}">
				<input type="hidden" id="userName" th:data-name="${session.loginUser.name}">
				<input type="hidden" id="userEmail" th:data-email="${session.loginUser.email}">
				<input type="hidden" id="userMobile" th:data-mobile="${session.loginUser.mobile}">
				<input type="hidden" id="userAddr1" th:data-addr="${session.loginUser.roadAddress}">
				<input type="hidden" id="userAddr2" th:data-addr="${session.loginUser.jibunAddress}">
				<input type="hidden" id="userAddr3" th:data-addr="${session.loginUser.detailAddress}">
				<input type="hidden" id="userAddr4" th:data-addr="${session.loginUser.extraAddress}">
				<input type="hidden" id="postcode" th:data-postcode="${session.loginUser.postcode}">
				<input type="hidden" class="isUser" th:data-user="true">
				<form th:action="@{/payment/history}" method="post">
					<input type="hidden" name="userName" th:value="${session.loginUser.name}">
					<input type="submit" value="결제이력">
				</form>
			</div> 
			<div id="buyPageDiv">
			</div>
		</div>
		
		<span th:utext="${loginUser}"></span>
	</div>
	<form action="/user/login/form" id="frm_login"></form>
	<!-- 프로필 사진 클릭시 팝업 창 -->
	<div class="backlayer blind"></div>
	<div class="gift_session blind">
		<div class="container_gift">
			<div class="gift_box">
				<div>
					<span th:text="${session.loginUser.artist}"></span> 님
				</div>
				<div><span th:text="${session.loginUser.email}"></span></div>
				<div>
					<div>
						<span id="remainingDay"></span>
					</div>
					<div>
						<span id="dDay"></span>
					</div>
				</div>					
				<div>
					<input type="button" value="TagMusic 계정관리" class="account_manage">
				</div>
				<div>
					<input type="button" value="로그아웃" class="btn_logout">
				</div>
				<script>
					$('.account_manage').click(function(){
						location.href='/user/mypage';
					});
					$('.btn_logout').click(function(){
						location.href='/user/logout';
					})
				</script>
				<input type="hidden" id="userEmail" th:data-email="${session.loginUser.email}">
			</div>
		</div>
	</div>
	<script>
		$('.backlayer').click(function(){
			$('.backlayer').addClass('blind');
			$('.gift_session').addClass('blind');
		});
	</script>

	
</body>
</html>