<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout/header::head('Tag Music')}"></head>
<meta charset="UTF-8">

<title></title>
<style>
	ul,ol{list-style:none}
	a{text-decoration:none;color:#fff962;font-size:15px}
	nav{overflow:hidden;height:80px;background-color:#1b2035; margin-top: 200px;}
	#nav3 {
	  width: 100%;
	  height: 15%;
	  position: relative;
	  text-align: center;
	}
	#nav3>a {
	  line-height: 80px;
	  display: block;
	  font-size: 30px;
	  font-weight: 900;
	  position: absolute;
	  left: 30px;
	}
	#nav3>select {
	  padding: 0 20px;
	  height: 30px;
	  background-color: #1b2035;
	  color: #fff;
	  position: absolute;
	  right: 30px;
	  top: 50%;
	  transform: translateY(-15px);
	  border: 2px solid #fff;
	  border-radius: 30px;
	}
	#nav3>ul {
	  display: inline-block;
	}
	#nav3>ul li {
	  float: left;
	  padding: 0 30px;
	}
	
	.payContent {
 		margin: 50px 50px 50px 410px;
 		position: relative;
 		width: 1200px;
	}
	#buyPageDiv{
		margin: 10px auto;
		padding: 50px;
		position: relative;
    	width: 100%;
    	background-color: #ECECEC;
    	
	}
	.pass_box {
		width: 420px;
		margin: auto;
	}
	.pass_name {
		position: relative;
		display: inline-block;
	}
	.pass_btn {
		position: relative;
		display: inline-block;
	}
	
	/* 선물 box */
	.blind {
		display: none;
	}
	.backlayer {
		position: absolute;
		top: 0;
		left: 0;
		background-color: rgba(0,0,0,0.7);
		z-index: 100;
		width: 100%;
		height:100%;
	}
	.gift_session {
		position: absolute;
		top: 0;
		left: 0;
		background-color: rgba(0,255,130,0);
		width: 100%;
		height:100%;
	}
	.container_gift {
		position: relative;
		z-index: 110;
		width: 420px;
		height: 300px;
		background-color: #00FF80;
		margin: 200px auto;
	}
	.gift_box {
		position: relative;
		margin: auto;
		padding-top: 40px;
		width: 350px;
		background-color: #00FF80;
		text-align: center;
	}
	
	
</style>
<!-- static 폴더 이후의 위치를 적으면 된다. -->
<script th:src="@{/js/jquery-3.6.1.min.js}"></script>
<script type="text/javascript" src="https://service.iamport.kr/js/iamport.payment-1.1.5.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

<script th:inline="javascript">
$(document).ready(function(){
	var userName = $('#userName').data('name');
	fn_userLog();
	fn_logRemove();
	if(userName != null){
		fn_userLog();
	} else {
		fn_isNotUser();
	}
	
 });
function fn_userLog(){
	var userEmail = $('#userEmail').data('email');
	var userName = $('#userName').data('name');
	$.ajax({
		type: 'post',
		url: '/payment/buyLogList',
		data: 'email=' + userEmail + '&page=' + $('#page').val(),
		dataType: 'json',
		success: function(resData){
			$('#list_head').empty();
		    $('#list_body').empty();
		    $('#list_foot').empty();
		  	
		    $('<tr>')
		    	.append($('<th>').text("주문번호"))	
		    	.append($('<th>').text("이용권이름"))
		    	.append($('<th>').text("결제날짜(시간)"))
		    	.append($('<th>').text("결제방식"))
		    	.append($('<th>').text("결제가격"))
		    	.append($('<th>').append('<input type="button" value="결제이력삭제" class="btn_logRemove">'))
		    	.appendTo('#list_head');
		    if(resData.logList.length == 0){
		    	$('<tr>')
		    	.append( $('<td colspan="6">').text('결제 내역이 없습니다!'))
		    	.appendTo('#list_body');
		  	}
			$.each(resData.logList, function(i, buyLog){
				
				const logDate = moment(buyLog.payLogDate).format('YYYY년 MM월 DD일 (HH시 mm분)');
				$('<tr>')
				.append( $('<td>').text(buyLog.payLogNo))
				//.append( $('<td>').text(buyLog.payLogName.substr(0, 6)))
				.append( $('<td>').text(buyLog.payLogName))
				.append( $('<td>').text(logDate))
				.append( $('<td>').text(buyLog.payLogPg))
				.append( $('<td>').text('₩' + buyLog.payLogPrice))
				.append($('<td>').append($('<input type="checkbox" name="logCheck" value="'+ buyLog.payLogNo +'">')))
				.appendTo('#list_body');
			});
			$('<tr>')
		       .append($('<td id="paging" colspan="9"></td>'))
		       .appendTo('#list_foot');
		       
		       
		       $('#paging').empty();
				var pageUtil = resData.pageUtil
				var paging = '';
				// 이전 블록
				if(pageUtil.beginPage != 1){
					paging += '<span class="enable_findLink" data-page="'+ (pageUtil.beginPage - 1) +'">◀</span>';
				}
				for(let p = pageUtil.beginPage; p <= pageUtil.endPage; p++){
					if(p == $('#page').val()){
						paging += '<strong>' + p + '</strong>';
					} else {
						paging += '<span class="enable_findLink" data-page="'+ p +'">' + p + '</span>';
					}
				}
				// 다음블록
				if(pageUtil.endPage != pageUtil.totalPage){
					paging += '<span class="enable_findLink" data-page="'+ (pageUtil.endPage + 1) +'">▶</span>';
				}
				
				$('#paging').append(paging);
		}
	});
}
function fn_logRemove(){
	$(document).on('click', '.btn_logRemove', function(){
		var payLogNo = [];
		if( $('input[name="logCheck"]:checked').length == 0){
			alert('삭제할 데이터를 선택해주세요');
		} else {
			if(confirm('결제이력 삭제시 환불요청에 어려움이 있을 수 있습니다. 정말로 삭제하시겠습니까?')){
				$('input[name="logCheck"]:checked').each(function (index) {
			    	payLogNo.push($(this).val());
			    });
			    $.ajax({
			    	type: 'post',
			    	url: '/payment/logRemove',
			    	data: {
			    		"payLogNo" : payLogNo
			    	},
			    	dataType: 'json',
			    	success: function(resData){
			    		alert(resData.result + '개의 결제 이력을 삭제하였습니다.');
			    		fn_userLog();
			    	}
			    });
			} else {
				$('input[name="logCheck"]').prop('checked', false);
			}
		}
	});
}
function fn_userLogSelect(){
	$('#pass_log').click(function(){
		$("#column").val("").prop("selected", true);
		fn_userLog();
	});
	$('#purchased_pass').click(function(){
		$("#column").val("BUY").prop("selected", true);
	});
	$('#gifted_pass').click(function(){
		$("#column").val("GIFT").prop("selected", true);
	});
}
</script>
</head>
<body>
	
	<div th:replace="~{layout/header.html::header_layout}"></div>

	<div class="session">
		<div th:replace="~{layout/side.html::side_layout}"></div>
		<div class="payContent">
			<form id="frm_search">
				<nav id="nav3">
					<h1 th:text="|${session.loginUser.name} 님의 결제이력|"></h1>
					<hr>
					<ul>
						<li>
							<a th:href="@{#}" id="pass_log">전체 결제이력</a>
						</li>
						<li>
							<a th:href="@{#}" id="purchased_pass">구매한 이력</a>
						</li>
						<li>
							<a th:href="@{#}" id="gifted_pass">선물한 이력</a>
						</li>
					</ul>
				</nav>
					<select id="column" name="column" class="blind">
				    	<option value=""></option>
				    	<option value="BUY">구매한</option>
				    	<option value="GIFT">선물한</option>
    				</select>
				<script>
					
				</script>
				
			</form>
			<input type="hidden" id="isUser" th:data-user="${session}">
			<div th:if="${session.loginUser != null}">
				<input type="hidden" id="userName" th:data-name="${session.loginUser.name}">
				<input type="hidden" id="userEmail" th:data-email="${session.loginUser.email}">
				<input type="hidden" id="userMobile" th:data-mobile="${session.loginUser.mobile}">
				<input type="hidden" id="userAddr1" th:data-addr="${session.loginUser.roadAddress}">
				<input type="hidden" id="userAddr2" th:data-addr="${session.loginUser.jibunAddress}">
				<input type="hidden" id="userAddr3" th:data-addr="${session.loginUser.detailAddress}">
				<input type="hidden" id="userAddr4" th:data-addr="${session.loginUser.extraAddress}">
				<input type="hidden" id="postcode" th:data-postcode="${session.loginUser.postcode}">
				<input type="hidden" class="isUser" th:data-user="true">
			</div> 
			<div id="buyPageDiv">
				<table>
					<thead id="list_head">
					</thead>
					<tbody id="list_body">
					</tbody>
					<tfoot id="list_foot">
					</tfoot>
				</table>
			</div>
		</div>
	</div>
	<form action="/user/login/form" id="frm_login"></form>
	<input type="hidden" id="page" value="1">
	
</body>
</html>